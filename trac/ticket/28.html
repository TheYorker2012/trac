<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>
          #28 (PHP Session Data on Server)
     –
      The Yorker
    </title>
        <link rel="search" href="../search.html" />
        <link rel="prev" href="39.html" title="Ticket #39" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="ticket_28-format=csv.csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="ticket_28-format=tab.tsv" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="ticket_28.xml.rss-format=rss.html" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="up" href="../report/1-sort=status&USER=nick_evans&page=1.html" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="26.html" title="Ticket #26" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search The Yorker" />
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/trac/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
        $("#changelog h3.change").addAnchor("Link to this change");
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[@id]").enable($(this).checked());
            $(this).siblings().filter("*[@id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="../../trac.html"><img src="../../apps-logo.png" alt="The Yorker" /></a>
      </div>
      <form id="search" action="/trac/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first">logged in as nick_evans</li><li><a href="../../trac.html">Logout</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li><a href="../browser.html">Browse Source</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li><a href="../newticket.html">New Ticket</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
            <li class="first "><span>&larr; <a class="prev" href="39.html" title="Ticket #39">Previous Ticket</a></span></li><li><a href="../report/1-sort=status&USER=nick_evans&page=1.html">Back to Query</a></li><li class="last"><span class="missing">Next Ticket &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1>
              Ticket #28
          <span class="status">(reopened defect)</span>
      </h1>
      <!-- Do not show the ticket (pre)view when the user first comes to the "New Ticket" page.
           Wait until they hit preview. -->
        <!-- Ticket Box (ticket fields along with description) -->
        <div id="ticket">
          <div class="date">
            <p>Opened <a class="timeline" href="../timeline-from=2009-05-19T20-49-55Z+0000&precision=second.html" title="2009-05-19T20:49:55Z+0000 in Timeline">6 years</a> ago</p>
            <p>Last modified <a class="timeline" href="../timeline-from=2010-01-31T11-19-06Z+0000&precision=second.html" title="2010-01-31T11:19:06Z+0000 in Timeline">6 years</a> ago</p>
          </div>
          <!-- use a placeholder if it's a new ticket -->
          <h2 class="summary searchable">PHP Session Data on Server</h2>
          <table class="properties">
            <tr>
              <th id="h_reporter">Reported by:</th>
              <td headers="h_reporter" class="searchable">james_hogan</td>
              <th id="h_owner">Owned by:</th>
              <td headers="h_owner">james_hogan
              </td>
            </tr>
            <tr>
                <th id="h_priority">
                  Priority:
                </th>
                <td headers="h_priority">
                      critical
                </td>
                <th id="h_milestone">
                  Milestone:
                </th>
                <td headers="h_milestone">
                      <a class="missing milestone" href="../roadmap.html" rel="nofollow"></a>
                </td>
            </tr><tr>
                <th id="h_component">
                  Component:
                </th>
                <td headers="h_component">
                      General
                </td>
                <th id="h_keywords">
                  Keywords:
                </th>
                <td headers="h_keywords" class="searchable">
                </td>
            </tr><tr>
                <th id="h_cc">
                  Cc:
                </th>
                <td headers="h_cc" class="searchable">
                      ado@…, webmaster@…
                </td>
                <th>
                </th>
                <td>
                </td>
            </tr>
          </table>
            <div class="description">
              <h3 id="comment:description">
                Description
              </h3>
              <form id="addreply" method="get" action="#comment">
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="description" />
                  <input type="submit" name="reply" value="Reply" title="Reply, quoting this description" />
                </div>
              </form>
              <div class="searchable">
                <p>
Hi guys<br />
</p>
<p>
I noticed the server went down this morning because of the inode limit. I've investigated and partially fixed it. Here's some more info.<br />
</p>
<p>
There were approximately 850000 php session files. According to <a class="ext-link" href="http://oscarm.org/news/detail/666-debian_php5_and_session_garbage_collection"><span class="icon">http://oscarm.org/news/detail/666-debian_php5_and_session_garbage_collection</span></a> debian uses a cron job to clean up session files instead of the usual php mechanism because of the tight permissions on /var/lib/php5/, but cron wasn't running, so I ran the raw command in the php5 cron job to clean the old sessions.<br />
</p>
<p>
Cron should probably be running so that this gets done, but i'm not sure if it wasn't running for any particular reason so I thought I'd better check before starting it. If we do start it then the timeout needs changing as its set to 24 minutes at the moment, but the login cookie is set to 30 days.<br />
</p>
<p>
I also noticed that sessions are being added almost every second and that almost every session was empty. When i tailed the access log it is googlebot. This actually makes sense because the yorker opens sessions automatically so that various bits of the site that use sessions (e.g. cross-redirect messages) can work easily.<br />
</p>
<p>
I have added an exit handler with register_shutdown_function which checks if the session is empty, and if so destroys the session data. See:<br />
<a class="ext-link" href="../../gitweb-p=theyorker-a=commitdiff-h=4c5d4f4d91ecb4b1cbc5508e2c65220a277937fd-hp=5572088676e9ae1456d76c01d948ce0c20619738.html"><span class="icon">http://dev2.theyorker.co.uk/gitweb?p=theyorker;a=commitdiff;h=4c5d4f4d91ecb4b1cbc5508e2c65220a277937fd;hp=5572088676e9ae1456d76c01d948ce0c20619738</span></a><br />
</p>
<p>
This has been applied to the live site, and I've deleted all empty sessions as well, and this has stopped the number of sessions increasing even though the access log is still going strong. Site still seems to work fine (login, logout, messages etc).<br />
</p>
<p>
Cheers<br />
-- <br />
James Hogan<br />
Lead Programmer<br />
mob: 07763 873104<br />
</p>

              </div>
            </div>
        </div>
          <h2>Attachments</h2>
          <div id="attachments">
    <form method="get" action="/trac/attachment/ticket/28/" id="attachfile">
      <div>
        <input type="hidden" name="action" value="new" />
        <input type="submit" name="attachfilebutton" value="Attach file" />
      </div>
    </form>
          </div>
          <h2>Change History</h2>
          <div id="changelog">
            <form method="get" action="#comment" class="printableform">
              <div class="change">
                <h3 class="change" id="comment:1">
                  Changed <a class="timeline" href="../timeline-from=2009-05-19T20-51-26Z+0000&precision=second.html" title="2009-05-19T20:51:26Z+0000 in Timeline">6 years</a> ago by webmaster
                </h3>
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="1" />
                  <input type="submit" value="Reply" title="Reply to comment 1" />
                </div>
      <div class="comment searchable">
        <p>
Can I just check that whatever needs to go into CRON has done so and it is now running, as well as on startup. Want to make sure this got dealt with and won't happen again. Thanks!<br />
</p>

      </div>
              </div>
            </form><form method="get" action="#comment" class="printableform">
              <div class="change">
                <h3 class="change" id="comment:2">
                  Changed <a class="timeline" href="../timeline-from=2009-05-19T22-11-41Z+0000&precision=second.html" title="2009-05-19T22:11:41Z+0000 in Timeline">6 years</a> ago by james_hogan
                </h3>
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="2" />
                  <input type="submit" value="Reply" title="Reply to comment 2" />
                </div>
      <ul class="changes">
        <li>
          <strong>status</strong>
              changed from <em>new</em> to <em>closed</em>
        </li><li>
          <strong>resolution</strong>
              set to <em>fixed</em>
        </li>
      </ul>
      <div class="comment searchable">
        <p>
i haven't touched cron myself, but it appears to be running at the moment (ps ax | grep cron shows it up).<br />
</p>
<p>
at the moment there are just 28 session files in /var/lib/php5 so the problem seems to be under control.<br />
</p>
<p>
i'll mark this as fixed unless you bring up any more issues with it<br />
</p>

      </div>
              </div>
            </form><form method="get" action="#comment" class="printableform">
              <div class="change">
                <h3 class="change" id="comment:3">
                  Changed <a class="timeline" href="../timeline-from=2010-01-31T11-05-58Z+0000&precision=second.html" title="2010-01-31T11:05:58Z+0000 in Timeline">6 years</a> ago by nick_evans
                </h3>
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="3" />
                  <input type="submit" value="Reply" title="Reply to comment 3" />
                </div>
      <ul class="changes">
        <li>
          <strong>status</strong>
              changed from <em>closed</em> to <em>reopened</em>
        </li><li>
          <strong>resolution</strong>
              <em>fixed</em> deleted
        </li>
      </ul>
      <div class="comment searchable">
        <p>
Housemates and I just solved the server issue. The PHP session directory ("/var/lib/php5") is HUGE, and we're not sure why, so we've moved it to "/var/lib/php5.old". Don't ls the "/var/lib/php5.old" directory or the server will hang, the hashtable of files stored in the directory is 65Mb!! That's 65 meg of file names, not file content!!! Madness.<br />
</p>
<p>
For future reference, if restarting Apache and MySQL doesn't solve the problem, and typing "top" reveals that the %wa score (see the top of the statistics of the "top" command) is constantly higher than 50%, it means that the hard disk is thrashing and you may want to consider the following:<br />
</p>
<p>
ls -lah /var/lib/<br />
</p>
<p>
and check size of "php5" directory<br />
</p>
<p>
if the size is above 4.0K, then (VERY CAREFULLY) type the following:<br />
</p>
<p>
rm -rf /var/lib/php5<br />
mikdir /var/lib/php5<br />
chmod a+w /var/lib/php5<br />
</p>
<p>
if this doesn't work because rm hangs, do the following instead:<br />
</p>
<p>
mv /var/lib/php5 /var/lib/php5.old2<br />
mikdir /var/lib/php5<br />
chmod a+w /var/lib/php5<br />
</p>
<p>
Hope that helps. Very strange issues indeed.<br />
</p>

      </div>
              </div>
            </form><form method="get" action="#comment" class="printableform">
              <div class="change">
                <h3 class="change" id="comment:4">
                  Changed <a class="timeline" href="../timeline-from=2010-01-31T11-07-13Z+0000&precision=second.html" title="2010-01-31T11:07:13Z+0000 in Timeline">6 years</a> ago by nick_evans
                </h3>
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="4" />
                  <input type="submit" value="Reply" title="Reply to comment 4" />
                </div>
      <div class="comment searchable">
        <p>
... we still need to find out why these sessions are being generated, and work out how to clean up the /var/lib/php5.old if we can (maybe running rm overnight?)<br />
</p>

      </div>
              </div>
            </form><form method="get" action="#comment" class="printableform">
              <div class="change">
                <h3 class="change" id="comment:5">
                  Changed <a class="timeline" href="../timeline-from=2010-01-31T11-19-06Z+0000&precision=second.html" title="2010-01-31T11:19:06Z+0000 in Timeline">6 years</a> ago by nick_evans
                </h3>
                <div class="inlinebuttons">
                  <input type="hidden" name="replyto" value="5" />
                  <input type="submit" value="Reply" title="Reply to comment 5" />
                </div>
      <div class="comment searchable">
        <p>
The problem with the server last night (why 'apache2ctl restart' didn't seem to work), was that Apache was trying to access the "/var/lib/php5" directory, which contained a ridiculous (read: way more than linux is designed to handle) number of files. At the same time there was a cron job running trying to clean up these files. This caused massive thrashing of the hard disk, which the %wa score mentioned above verifies, and slowed the entire server to a crawl. 'apache2ctl restart' was killing the processes, but the processes were remaining in the dead state and not being cleaned up, as the server was running so ridiculously slowly, and the OS was still catching up with all the disk requests. In the end we had to actually restart the server as it was so bad, and quickly rename the /var/lib/php5 directory before anything started accessing it again.<br />
</p>
<p>
As I said above, we need to work out why so many sessions are accumulating. Is the Cron working? Is james's fix mentioned above working?<br />
</p>

      </div>
              </div>
            </form>
          </div>
      <form action="/trac/ticket/28" method="post" id="propertyform"><div><input type="hidden" name="__FORM_TOKEN" value="57865d0a2909cdb4e95711e4" /></div>
        <h3><a id="edit" onfocus="$('#comment').get(0).focus()">
            Add/Change #28 (PHP Session Data on Server)</a></h3>
        <div class="field">
          <fieldset class="iefix">
            <label for="comment">Comment (you may use
              <a tabindex="42" href="../wiki/WikiFormatting.html">WikiFormatting</a>
              here):
            </label><br />
            <p><textarea id="comment" name="comment" class="wikitext" rows="10" cols="78">
</textarea></p>
          </fieldset>
        </div>
        <fieldset id="properties">
          <legend>Change Properties</legend>
          <table>
            <tr>
              <th><label for="field-summary">Summary:</label></th>
              <td class="fullrow" colspan="3">
                <input type="text" id="field-summary" name="field_summary" value="PHP Session Data on Server" size="70" />
              </td>
            </tr>
            <tr>
                <th class="col1">
                  <label for="field-type">Type:</label>
                </th>
                <td class="col1">
                    <select id="field-type" name="field_type">
                      <option selected="selected">defect</option><option>enhancement</option><option>functionality</option><option>refactor</option><option>task</option><option>browser incompatibility</option>
                    </select>
                </td>
                <th class="col2">
                  <label for="field-priority">Priority:</label>
                </th>
                <td class="col2">
                    <select id="field-priority" name="field_priority">
                      <option>blocker</option><option selected="selected">critical</option><option>major</option><option>minor</option><option>trivial</option>
                    </select>
                </td>
            </tr><tr>
                <th class="col1">
                  <label for="field-milestone">Milestone:</label>
                </th>
                <td class="col1">
                    <select id="field-milestone" name="field_milestone">
                      <option></option>
                      <optgroup label="Open (by due date)">
                        <option>Freshers 2009</option>
                      </optgroup><optgroup label="Open (no due date)">
                      </optgroup>
                    </select>
                </td>
                <th class="col2">
                  <label for="field-component">Component:</label>
                </th>
                <td class="col2">
                    <select id="field-component" name="field_component">
                      <option>Article Manager</option><option>Calendar</option><option>Crosswords</option><option>Facebook App</option><option>Feeds</option><option>Gallery</option><option>Gamezone</option><option>Gatekeeping</option><option selected="selected">General</option><option>Home Pages</option><option>IRC Client</option><option>Lemon Press + Generalisation</option><option>My account</option><option>Office General</option><option>Pages System</option><option>Permissions</option><option>Redesign Styles</option><option>Server Admin</option><option>Wikiparser</option>
                    </select>
                </td>
            </tr><tr>
                <th class="col1">
                  <label for="field-keywords">Keywords:</label>
                </th>
                <td class="col1">
                        <input type="text" id="field-keywords" name="field_keywords" value="" />
                </td>
                <th class="col2">
                  <label for="field-cc">Add to Cc:</label>
                </th>
                <td class="col2">
                        <span>
                          <em>nick_evans</em>
                          <input type="checkbox" id="field-cc" name="cc_update" title="This checkbox allows you to add or remove yourself from the CC list." />
                        </span>
                </td>
            </tr>
          </table>
        </fieldset>
          <fieldset id="action">
            <legend>Action</legend>
            <div>
              <input type="radio" id="action_leave" name="action" value="leave" checked="checked" />
                <label for="action_leave">leave</label>
                as reopened
                <span class="hint"></span>
            </div><div>
              <input type="radio" id="action_resolve" name="action" value="resolve" />
                <label for="action_resolve">resolve</label>
                as <select name="action_resolve_resolve_resolution" id="action_resolve_resolve_resolution"><option selected="selected">fixed</option><option>invalid</option><option>wontfix</option><option>duplicate</option><option>worksforme</option></select>
                <span class="hint">The resolution will be set. Next status will be 'closed'</span>
            </div><div>
              <input type="radio" id="action_reassign" name="action" value="reassign" />
                <label for="action_reassign">reassign</label>
                to <input type="text" name="action_reassign_reassign_owner" value="nick_evans" id="action_reassign_reassign_owner" />
                <span class="hint">The owner will change. Next status will be 'assigned'</span>
            </div><div>
              <input type="radio" id="action_accept" name="action" value="accept" />
                <label for="action_accept">accept</label>
                <span class="hint">The owner will change to nick_evans. Next status will be 'accepted'</span>
            </div>
          </fieldset>
        <div class="buttons">
            <input type="hidden" name="ts" value="2010-01-31 11:19:06+00:00" />
            <input type="hidden" name="replyto" />
            <input type="hidden" name="cnum" value="6" />
          <input type="submit" name="preview" value="Preview" /> 
          <input type="submit" name="submit" value="Submit changes" />
        </div>
      </form>
      <div id="help">
        <strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.
      </div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="ticket_28-format=csv.csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="ticket_28-format=tab.tsv" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="ticket_28.xml.rss-format=rss.html" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">
        Powered by <a href="../about.html"><strong>Trac 0.11.1</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.
      </p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>