#!/bin/bash

# Input and output files
input="restaurants.data"
output="restaurants.sql"

if [ ! -e $input ]; then
	echo 1>&2 "$input not found"
	exit 1;
fi

# end of line comment
comment="--"

input_format="^\([^,]*\), \([0-9 \-]*\), \(.*\) \([A-Z][A-Z][0-9][0-9]\?\)[ ]\?\([0-9][A-Z][A-Z]\)$"
venue_id="6"
branch_id="4"

# header
echo "$comment Generated by $0" > $output
# parameters
echo "$comment Input: $input" >> $output
echo "$comment Output: $output" >> $output
echo "" >> $output

echo "$comment Uncomment below to replace all current records." >> $output
echo "$comment DELETE FROM \`entities\`;" >> $output
echo "$comment DELETE FROM \`organisations\`;" >> $output
echo "" >> $output

echo "START TRANSACTION;" >> $output
echo "" >> $output

lastname=""
duplicates=0

while read line
do
	name=`echo "$line" | sed "s/$input_format/\1/"`
	phone=`echo "$line" | sed "s/$input_format/\2/"`
	address=`echo "$line" | sed "s/$input_format/\3/"`
	postcode=`echo "$line" | sed "s/$input_format/\4 \5/"`
	
	directory_entry=`./directory-entry-from-org-name "$name"`
	
	if [ "$name" = "$lastname" ]
	then
		echo $name
		duplicates=`expr $duplicates + 1`
		linecomment="$comment"
	else
		linecomment=""
	fi
	lastname="$name"
	
	echo "$linecomment INSERT INTO \`entities\` (\`entity_deleted\` )  VALUES ('0');
$linecomment INSERT INTO \`organisations\` (
$linecomment   \`organisation_entity_id\` ,
$linecomment   \`organisation_organisation_type_id\` ,
$linecomment   \`organisation_name\` ,
$linecomment   \`organisation_address\` ,
$linecomment   \`organisation_postcode\` ,
$linecomment   \`organisation_directory_entry_name\` ,
$linecomment   \`organisation_events\` ,
$linecomment   \`organisation_hits\` )
$linecomment VALUES ( LAST_INSERT_ID(), '6', '$name', '$address', '$postcode' , '$directory_entry', '1', '0' );
" >> $output

done < $input

echo "COMMIT;" >> $output

echo "$duplicates duplicates need handling manually"

exit 0
